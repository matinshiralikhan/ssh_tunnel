# Auto-Discovery قابلیت شناسایی و راه‌اندازی خودکار

## 🚀 معرفی

قابلیت **Auto-Discovery** امکان شناسایی خودکار و راه‌اندازی پروتکل‌های مختلف تونل بر روی یک سرور SSH را فراهم می‌کند. با ارائه اطلاعات اولیه یک سرور (IP، username، password)، سیستم به طور خودکار:

- قابلیت‌های سرور را شناسایی می‌کند
- پروتکل‌های پشتیبانی شده را تشخیص می‌دهد  
- به طور اختیاری پروتکل‌ها را نصب و راه‌اندازی می‌کند
- فایل‌های کانفیگ کلاینت برای تمام پروتکل‌ها تولید می‌کند

## 📋 فهرست پروتکل‌های پشتیبانی شده

### ✅ پروتکل‌هایی که خودکار راه‌اندازی می‌شوند:

1. **SSH Tunnel** - تونل SSH استاندارد با SOCKS5/HTTP proxy
2. **V2Ray/VMess** - پروتکل VMess با WebSocket transport  
3. **VLESS** - پروتکل VLESS مدرن و بهینه
4. **Trojan** - پروتکل Trojan با پوشش TLS
5. **Hysteria** - پروتکل UDP سریع با obfuscation
6. **WireGuard** - VPN مدرن با کارایی بالا
7. **HTTP Proxy** - پروکسی HTTP ساده
8. **SOCKS5 Proxy** - پروکسی SOCKS5 با DNS tunneling
9. **ICMP Tunnel** - تونل ICMP برای bypassing خاص

## 🛠️ نحوه استفاده

### 1. شناسایی ساده سرور (بدون نصب):

```bash
./ssh-tunnel-manager -autodiscover -host 1.2.3.4 -user root -password mypassword
```

### 2. شناسایی با SSH Key:

```bash  
./ssh-tunnel-manager -autodiscover -host 1.2.3.4 -user root -key ~/.ssh/id_rsa
```

### 3. شناسایی + راه‌اندازی خودکار پروتکل‌ها:

```bash
./ssh-tunnel-manager -autodiscover -host 1.2.3.4 -user root -password mypass -setup
```

### 4. تعیین دایرکتوری خروجی سفارشی:

```bash
./ssh-tunnel-manager -autodiscover -host 1.2.3.4 -user root -password mypass -output /my/configs
```

### 5. کامبو کامل (شناسایی + راه‌اندازی + کانفیگ):

```bash
./ssh-tunnel-manager -autodiscover \
  -host 1.2.3.4 \
  -user root \
  -password mypassword \
  -setup \
  -output client-configs
```

## 📊 نمونه خروجی

```
🔍 Starting Auto-Discovery Process...
Target: root@1.2.3.4:22
Output Directory: client-configs

📡 Discovering server capabilities...

🖥️  Server Information:
   Host: 1.2.3.4
   OS: Linux
   Architecture: x86_64
   Available Ports: [8080, 8081, 8082, 8083, 8084]
   Installed Software: [docker, nginx, iptables]
   Supported Protocols: [ssh, v2ray, vless, vmess, trojan, hysteria, wireguard, http_proxy, socks5_proxy]

⚙️  Setting up protocols on server...
✅ Protocol setup completed!

📁 Generating client configuration files...
🔧 Generating SSH Tunnel Manager configuration...

🎉 Auto-Discovery Completed Successfully!

📋 Generated Files:
   📂 Output Directory: client-configs/
   📄 Configuration Files:
      • ssh_tunnel.conf
      • v2ray_client.conf
      • vless_client.conf
      • vmess_client.conf
      • trojan_client.conf
      • wireguard.conf
      • hysteria.conf
      • http_proxy.conf
      • socks5_proxy.conf
      • combined_config.yaml
      • ssh-tunnel-manager-config.yaml

🚀 Quick Start:
   1. Use SSH Tunnel Manager: ./ssh-tunnel-manager -config client-configs/ssh-tunnel-manager-config.yaml
   2. Or use individual clients with their respective config files

🔗 Available Proxy URLs:
   SSH Proxy: socks5://127.0.0.1:8080
   HTTP Proxy: socks5://127.0.0.1:8081
   SOCKS5 Proxy: socks5://127.0.0.1:8082

💡 Tips:
   • Edit the generated configs to customize settings
   • Use -setup flag to automatically install protocols on server
   • Check server firewall settings if connections fail
   • Run with -server flag to enable web management interface
```

## 📁 فایل‌های تولید شده

### 1. **ssh-tunnel-manager-config.yaml**
کانفیگ اصلی SSH Tunnel Manager برای استفاده مستقیم:

```yaml
version: "1.0"
servers:
  - name: "auto-ssh-1.2.3.4"
    host: "1.2.3.4"
    port: "22"
    user: "root"
    password: "mypassword"
    transport: "ssh"
    proxy: "socks5"
    local_port: 8080
    enabled: true
auto_select: true
api:
  enabled: true
  port: 8888
```

### 2. **vless_client.conf**
کانفیگ VLESS برای کلاینت‌هایی مثل V2rayN:

```
# VLESS Configuration
vless://12345678-1234-1234-1234-123456789abc@1.2.3.4:8081?type=tcp&security=none#AutoGenerated-VLESS

# For V2rayN/V2rayNG:
# 1. Copy the above URL
# 2. Import via QR code or URL
# 3. Connect and enjoy!
```

### 3. **trojan_client.conf**
کانفیگ کامل Trojan:

```json
{
  "run_type": "client",
  "local_addr": "127.0.0.1", 
  "local_port": 1080,
  "remote_addr": "1.2.3.4",
  "remote_port": 8082,
  "password": ["auto-generated-password-123"]
}
```

### 4. **ssh_tunnel.conf**
کانفیگ SSH Tunnel کلاسیک:

```
# SSH Tunnel Configuration
Host tunnel-server
    HostName 1.2.3.4
    Port 22
    User root
    DynamicForward 8080

# Usage:
# ssh -D 8080 root@1.2.3.4
# Set browser proxy to SOCKS5 127.0.0.1:8080
```

## 🔧 پارامترهای CLI

| پارامتر | اجباری | توضیحات | مثال |
|---------|--------|---------|-------|
| `-autodiscover` | ✅ | فعال‌سازی حالت auto-discovery | `-autodiscover` |
| `-host` | ✅ | IP یا hostname سرور | `-host 1.2.3.4` |
| `-user` | ✅ | نام کاربری SSH | `-user root` |
| `-password` | ⚠️ | رمز عبور SSH (یکی از password یا key الزامی) | `-password mypass` |
| `-key` | ⚠️ | مسیر کلید خصوصی SSH | `-key ~/.ssh/id_rsa` |
| `-setup-port` | ❌ | پورت SSH (پیش‌فرض: 22) | `-setup-port 2222` |
| `-setup` | ❌ | نصب خودکار پروتکل‌ها بر روی سرور | `-setup` |
| `-output` | ❌ | دایرکتوری خروجی (پیش‌فرض: client-configs) | `-output /my/path` |

## 🎯 سناریوهای استفاده

### سناریو 1: تست سریع سرور جدید

```bash
# فقط بررسی قابلیت‌های سرور بدون تغییر
./ssh-tunnel-manager -autodiscover -host new-server.com -user ubuntu -key ~/.ssh/aws-key.pem
```

### سناریو 2: راه‌اندازی کامل سرور VPN

```bash
# راه‌اندازی کامل تمام پروتکل‌ها
./ssh-tunnel-manager -autodiscover \
  -host my-vps.com \
  -user root \
  -password strongpass123 \
  -setup \
  -output production-configs
```

### سناریو 3: ایجاد فایل‌های کانفیگ برای تیم

```bash
# تولید کانفیگ‌ها برای اشتراک با اعضای تیم
./ssh-tunnel-manager -autodiscover \
  -host team-server.com \
  -user devops \
  -key ~/.ssh/team-key \
  -output team-configs
```

### سناریو 4: Migration از سرور قدیمی

```bash
# کپی کردن تنظیمات از سرور قدیمی
./ssh-tunnel-manager -autodiscover -host old-server.com -user admin -password oldpass -output migration-backup
```

## 🔍 عملکرد تشخیص خودکار

### 1. **تشخیص سیستم‌عامل:**
- Linux distributions (Ubuntu, CentOS, Debian, Alpine)
- Architecture detection (x86_64, arm64, etc.)

### 2. **تشخیص نرم‌افزارهای نصب شده:**
- Docker (امکان نصب پروتکل‌های مختلف)
- Nginx (امکان reverse proxy)
- XRay/V2Ray (پروتکل‌های پیشرفته)
- WireGuard (VPN مدرن)
- iptables (فایروال و routing)

### 3. **تشخیص پورت‌های آزاد:**
- اسکن پورت‌های معمول (8080-8085, 9080-9082, 10080-10081)
- تست availability هر پورت
- تخصیص خودکار پورت به هر پروتکل

### 4. **تشخیص قابلیت‌های شبکه:**
- Network interfaces
- Public/Private IP detection
- Firewall status checking

## ⚙️ راه‌اندازی خودکار پروتکل‌ها

### 🐳 نصب با Docker:
```bash
# V2Ray
docker run -d --name v2ray -p 8080:8080 v2fly/v2fly-core:latest

# Trojan  
docker run -d --name trojan -p 8081:443 trojangfw/trojan:latest

# Hysteria
docker run -d --name hysteria -p 8082:36712/udp tobyxdd/hysteria:latest

# WireGuard
docker run -d --name wireguard --cap-add=NET_ADMIN linuxserver/wireguard:latest
```

### 📦 نصب مستقیم:
- Package manager detection (apt, yum, apk)
- Automatic dependency installation
- Service configuration and startup

## 🔐 ملاحظات امنیتی

### ⚠️ تنظیمات امنیتی مهم:
1. **تغییر رمزهای auto-generated**
2. **کانفیگ فایروال سرور**
3. **محدود کردن دسترسی بر اساس IP**
4. **استفاده از SSH keys به جای password**
5. **رمزگذاری فایل‌های کانفیگ**

### 🛡️ Best Practices:
```bash
# استفاده امن با SSH key
./ssh-tunnel-manager -autodiscover \
  -host secure-server.com \
  -user limited-user \
  -key ~/.ssh/secure-key \
  -output secure-configs

# محدود کردن دسترسی
chmod 600 secure-configs/*
```

## 🚀 استفاده از فایل‌های تولید شده

### 1. استفاده مستقیم با SSH Tunnel Manager:
```bash
./ssh-tunnel-manager -config client-configs/ssh-tunnel-manager-config.yaml -server
```

### 2. استفاده با کلاینت‌های V2Ray:
```bash
# V2rayN (Windows)
# Import URL from vless_client.conf

# V2rayNG (Android)  
# Scan QR code generated from config
```

### 3. استفاده با Trojan clients:
```bash
trojan -c client-configs/trojan_client.conf
```

### 4. استفاده با WireGuard:
```bash
sudo wg-quick up client-configs/wireguard.conf
```

## 🎛️ کانفیگ پیشرفته

### ترکیب با فایل کانفیگ موجود:

```yaml
# ادغام سرورهای auto-discovered با کانفیگ موجود
version: "1.0"
servers:
  # سرورهای دستی
  - name: "manual-server"
    host: "manual.example.com"
    # ... کانفیگ دستی
  
  # سرورهای auto-discovered (copy از generated config)
  - name: "auto-ssh-1.2.3.4"
    host: "1.2.3.4"
    # ... کانفیگ auto-generated
```

## 🔄 بروزرسانی و Maintenance

### بروزرسانی کانفیگ‌ها:
```bash
# بروزرسانی مجدد پس از تغییرات سرور
./ssh-tunnel-manager -autodiscover \
  -host updated-server.com \
  -user root \
  -password newpass \
  -output updated-configs
```

### پاکسازی کانفیگ‌های قدیمی:
```bash
rm -rf old-configs/
```

## 💡 نکات و ترفندها

### 1. **تست کانفیگ‌ها:**
```bash
# تست SSH tunnel
ssh -D 8080 -f -C -q -N root@1.2.3.4

# تست HTTP proxy  
curl --proxy http://127.0.0.1:8081 http://httpbin.org/ip
```

### 2. **مانیتورینگ کانکشن‌ها:**
```bash
# نمایش کانکشن‌های فعال
netstat -tulpn | grep 8080

# مانیتورینگ ترافیک
iftop -i tun0
```

### 3. **Performance Tuning:**
```bash
# بهینه‌سازی TCP
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf
sysctl -p
```

### 4. **Backup کانفیگ‌ها:**
```bash
tar -czf tunnel-configs-backup.tar.gz client-configs/
```

این قابلیت Auto-Discovery امکان راه‌اندازی سریع و آسان سرورهای تونل با حداقل مداخله دستی را فراهم می‌کند! 🚀 